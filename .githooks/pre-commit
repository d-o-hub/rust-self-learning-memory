#!/bin/bash
# Pre-commit hook for rust-self-learning-memory
# Ensures code quality before commits

set -e

echo "ğŸ” Running pre-commit quality checks..."

# 1. Check code formatting
echo "  â”œâ”€ Checking code formatting..."
if ! cargo fmt --all -- --check >/dev/null 2>&1; then
    echo "  âŒ Code is not formatted. Running cargo fmt..."
    cargo fmt --all
    echo "  âœ… Code formatted. Please review changes and commit again."
    exit 1
fi
echo "  âœ… Code formatting OK"

# 2. Run Clippy
echo "  â”œâ”€ Running clippy..."
if ! cargo clippy --all -- -D warnings 2>&1 | grep -q "Finished"; then
    echo "  âŒ Clippy warnings found. Please fix before committing."
    cargo clippy --all -- -D warnings
    exit 1
fi
echo "  âœ… Clippy OK"

# 3. Run tests (lib and bins only, skip long-running integration tests)
echo "  â”œâ”€ Running tests..."
if ! cargo test --lib --bins --quiet 2>&1 | grep -q "test result: ok"; then
    echo "  âŒ Tests failed. Please fix before committing."
    cargo test --lib --bins
    exit 1
fi
echo "  âœ… Tests OK"

# 4. Run documentation tests
echo "  â”œâ”€ Running documentation tests..."
if ! cargo test --doc --quiet 2>&1 | grep -q "test result: ok"; then
    echo "  âŒ Documentation tests failed. Please fix before committing."
    cargo test --doc
    exit 1
fi
echo "  âœ… Documentation tests OK"

echo "âœ… All pre-commit checks passed!"
