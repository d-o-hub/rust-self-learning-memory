#!/bin/bash
# Pre-push hook for rust-self-learning-memory
# Prevents pushing tags without full verification

set -e

# Read stdin to get information about what's being pushed
while read local_ref local_sha remote_ref remote_sha; do
    # Check if we're pushing a tag
    if [[ $local_ref == refs/tags/* ]]; then
        tag_name="${local_ref#refs/tags/}"

        echo "ðŸ·ï¸  Detected tag push: $tag_name"
        echo "ðŸ” Running comprehensive verification before pushing tag..."

        # Checkout the tag to verify it
        current_branch=$(git rev-parse --abbrev-ref HEAD)
        git checkout "$tag_name" --quiet 2>/dev/null || {
            echo "  âŒ Cannot checkout tag $tag_name"
            exit 1
        }

        # 1. Check code formatting
        echo "  â”œâ”€ Checking code formatting..."
        if ! cargo fmt --all -- --check >/dev/null 2>&1; then
            echo "  âŒ Code is not formatted for tag $tag_name"
            git checkout "$current_branch" --quiet 2>/dev/null || git checkout -
            exit 1
        fi
        echo "  âœ… Code formatting OK"

        # 2. Run Clippy
        echo "  â”œâ”€ Running clippy..."
        if ! cargo clippy --all -- -D warnings 2>&1 | grep -q "Finished"; then
            echo "  âŒ Clippy warnings found in tag $tag_name"
            git checkout "$current_branch" --quiet 2>/dev/null || git checkout -
            exit 1
        fi
        echo "  âœ… Clippy OK"

        # 3. Compile release build
        echo "  â”œâ”€ Building release binary..."
        if ! cargo build --release --quiet 2>&1 | grep -q "Finished"; then
            echo "  âŒ Release build failed for tag $tag_name"
            git checkout "$current_branch" --quiet 2>/dev/null || git checkout -
            exit 1
        fi
        echo "  âœ… Release build OK"

        # 4. Run all tests
        echo "  â”œâ”€ Running full test suite..."
        if ! cargo test --lib --bins --quiet 2>&1 | grep -q "test result: ok"; then
            echo "  âŒ Tests failed for tag $tag_name"
            echo "  Please fix tests before pushing this tag."
            git checkout "$current_branch" --quiet 2>/dev/null || git checkout -
            exit 1
        fi
        echo "  âœ… All tests passed"

        # Return to original branch
        git checkout "$current_branch" --quiet 2>/dev/null || git checkout -

        echo "âœ… Tag $tag_name verified and ready to push!"
        echo ""
    fi
done

exit 0
