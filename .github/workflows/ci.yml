---
name: CI
permissions:
  contents: read

"on":
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_run:
    workflows: ["Quick Check"]
    types: [completed]
    branches: [main, develop]

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  # Wait for quick check to pass on PRs
  check-quick-check:
    name: Check Quick Check Status
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Wait for Quick Check
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'Quick PR Check (Format + Clippy)'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  format:
    name: Format Check
    runs-on: ubuntu-latest
    needs: [check-quick-check]
    if: >-
      ${{
        always() &&
        (needs.check-quick-check.result == 'success' || needs.check-quick-check.result == 'skipped') &&
        (github.event_name == 'push' ||
        github.event_name == 'pull_request' ||
        github.event.workflow_run.conclusion == 'success')
      }}
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    needs: [check-quick-check]
    if: >-
      ${{
        always() &&
        (needs.check-quick-check.result == 'success' || needs.check-quick-check.result == 'skipped') &&
        (github.event_name == 'push' ||
        github.event_name == 'pull_request' ||
        github.event.workflow_run.conclusion == 'success')
      }}
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: ${{ matrix.os }}
    needs: [check-quick-check]
    if: >-
      ${{
        always() &&
        (needs.check-quick-check.result == 'success' || needs.check-quick-check.result == 'skipped') &&
        (github.event_name == 'push' ||
        github.event_name == 'pull_request' ||
        github.event.workflow_run.conclusion == 'success')
      }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Run tests
        run: cargo test --all-features --workspace
        env:
          RUST_LOG: debug
          QUALITY_GATE_SKIP_OPTIONAL: true

  cli-test:
    name: CLI Test
    runs-on: ubuntu-latest
    needs: [check-quick-check]
    if: >-
      ${{
        always() &&
        (needs.check-quick-check.result == 'success' || needs.check-quick-check.result == 'skipped') &&
        (github.event_name == 'push' ||
        github.event_name == 'pull_request' ||
        github.event.workflow_run.conclusion == 'success')
      }}
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Build CLI
        run: cargo build --package memory-cli --features full
      - name: Run CLI unit tests
        run: cargo test --package memory-cli --features full --lib
      - name: Run CLI integration tests
        run: cargo test --package memory-cli --features full --test integration_tests
      - name: Run CLI security tests
        run: cargo test --package memory-cli --features full --test security_tests
      - name: Test CLI binary execution
        run: |
          ./target/debug/memory-cli --help
          ./target/debug/memory-cli --version

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [check-quick-check]
    if: >-
      ${{
        always() &&
        (needs.check-quick-check.result == 'success' || needs.check-quick-check.result == 'skipped') &&
        (github.event_name == 'push' ||
        github.event_name == 'pull_request' ||
        github.event.workflow_run.conclusion == 'success')
      }}
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Build all crates with timing
        run: cargo build --all --release --timings
      - name: Upload build timing report
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: build-timings
          path: target/cargo-timings/cargo-timing.html
          retention-days: 7

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: [check-quick-check]
    if: >-
      ${{
        always() &&
        (needs.check-quick-check.result == 'success' || needs.check-quick-check.result == 'skipped') &&
        (github.event_name == 'push' ||
        github.event_name == 'pull_request' ||
        github.event.workflow_run.conclusion == 'success')
      }}
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /opt/hostedtoolcache/*
          sudo rm -rf /usr/share/dotnet/*
          sudo rm -rf /usr/local/lib/android/*
          sudo rm -rf /opt/ghc/*
          sudo apt-get clean
          df -h
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov
      - name: Generate coverage reports and check threshold
        run: |
          cargo llvm-cov clean --workspace
          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info --ignore-run-fail

          # Extract coverage percentage from LCOV file
          # LH = lines hit, LF = lines found
          LH=$(grep -oP '^LH:\K\d+' lcov.info | awk '{s+=$1} END {print s}')
          LF=$(grep -oP '^LF:\K\d+' lcov.info | awk '{s+=$1} END {print s}')

          if [ -z "$LF" ] || [ "$LF" -eq "0" ]; then
            echo "::error::No coverage data found in lcov.info"
            exit 1
          fi

          COVERAGE=$(awk "BEGIN {printf \"%.2f\", ($LH/$LF)*100}")
          echo "Coverage: ${COVERAGE}% (${LH}/${LF} lines)"

          # Check coverage threshold
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            THRESHOLD=66
          else
            THRESHOLD=80
          fi
          COVERAGE_INT=$(echo "$COVERAGE" | cut -d'.' -f1)
          if [ "$COVERAGE_INT" -lt "$THRESHOLD" ]; then
            echo "::error::Coverage ${COVERAGE}% is below ${THRESHOLD}% threshold"
            exit 1
          fi
          echo "Coverage check passed: ${COVERAGE}% >= ${THRESHOLD}% (${GITHUB_EVENT_NAME})"
        env:
          RUST_LOG: debug
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5.5.1
        with:
          files: lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: coverage-report
          path: lcov.info
          retention-days: 7

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [check-quick-check]
    if: >-
      ${{
        always() &&
        (needs.check-quick-check.result == 'success' || needs.check-quick-check.result == 'skipped') &&
        (github.event_name == 'push' ||
        github.event_name == 'pull_request' ||
        github.event.workflow_run.conclusion == 'success')
      }}
    steps:
      - uses: actions/checkout@v6
      - uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  supply-chain:
    name: Supply Chain Security (cargo-deny)
    runs-on: ubuntu-latest
    needs: [check-quick-check]
    if: >-
      ${{
        always() &&
        (needs.check-quick-check.result == 'success' || needs.check-quick-check.result == 'skipped') &&
        (github.event_name == 'push' ||
        github.event_name == 'pull_request' ||
        github.event.workflow_run.conclusion == 'success')
      }}
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Install cargo-deny
        uses: taiki-e/install-action@cargo-deny
      - name: Run cargo-deny
        run: cargo deny check
      - name: Upload deny report
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: cargo-deny-report
          path: target/deny.log
          retention-days: 7
          if-no-files-found: ignore

  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [check-quick-check, format, clippy, test, cli-test, coverage, security-audit]
    if: >-
      ${{
        always() &&
        (needs.check-quick-check.result == 'success' || needs.check-quick-check.result == 'skipped') &&
        (github.event_name == 'push' ||
        github.event_name == 'pull_request' ||
        github.event.workflow_run.conclusion == 'success')
      }}
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /opt/hostedtoolcache/*
          sudo rm -rf /usr/share/dotnet/*
          sudo rm -rf /usr/local/lib/android/*
          sudo rm -rf /opt/ghc/*
          sudo apt-get clean
          df -h
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt, llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Install required tools
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov,cargo-audit
      - name: Run Quality Gates
        run: cargo test --test quality_gates -- --nocapture --skip quality_gate_test_coverage
        env:
          RUST_LOG: info
          QUALITY_GATE_COVERAGE_THRESHOLD: "90"
          QUALITY_GATE_PATTERN_ACCURACY_THRESHOLD: "70"
          QUALITY_GATE_COMPLEXITY_THRESHOLD: "10"
          QUALITY_GATE_SECURITY_THRESHOLD: "0"
      - name: Generate Quality Report
        if: always()
        run: |
          {
            echo "# Quality Gates Report"
            echo ""
            echo "**Date:** $(date)"
            echo ""
            echo "## Configuration"
            echo "- Coverage Threshold: ${QUALITY_GATE_COVERAGE_THRESHOLD}%"
            echo "- Pattern Accuracy Threshold: ${QUALITY_GATE_PATTERN_ACCURACY_THRESHOLD}%"
            echo "- Complexity Threshold: ${QUALITY_GATE_COMPLEXITY_THRESHOLD}"
            echo "- Security Vuln Threshold: ${QUALITY_GATE_SECURITY_THRESHOLD}"
            echo ""
          } > quality-report.md
        env:
          QUALITY_GATE_COVERAGE_THRESHOLD: "90"
          QUALITY_GATE_PATTERN_ACCURACY_THRESHOLD: "70"
          QUALITY_GATE_COMPLEXITY_THRESHOLD: "10"
          QUALITY_GATE_SECURITY_THRESHOLD: "0"
      - name: Upload quality report
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: quality-gates-report
          path: quality-report.md
          retention-days: 30
