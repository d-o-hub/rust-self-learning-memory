---
name: CI
permissions:
  contents: read
  checks: write
  security-events: write

"on":
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # Essential checks - run in parallel for faster feedback
  essential:
    name: Essential Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        job: [format, clippy, doctest]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}

      - name: Format Check
        if: matrix.job == 'format'
        run: cargo fmt --all -- --check

      - name: Clippy
        if: matrix.job == 'clippy'
        run: cargo clippy --all-targets -- -D warnings

      - name: Documentation Tests
        if: matrix.job == 'doctest'
        run: |
          chmod +x scripts/*.sh
          ./scripts/check-doctests.sh

  # Core testing - optimized for speed with proper timeouts
  test:
    name: Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /opt/hostedtoolcache/* || true
          sudo apt-get clean || true
          df -h
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold
      - name: Install nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest
      - name: Run tests with timeout protection
        run: |
          # Run library tests for core packages (fast, isolated tests)
          echo "Running memory-core library tests..."
          cargo nextest run --package memory-core --lib
          echo "Running memory-storage-turso library tests..."
          cargo nextest run --package memory-storage-turso --lib
          echo "Running memory-storage-redb library tests..."
          cargo nextest run --package memory-storage-redb --lib
          echo "Library tests completed successfully"

  # MCP builds - simplified with timeout protection
  mcp-build:
    name: MCP Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        feature: [default, wasm-rquickjs]
    steps:
      - name: Free disk space for WASM builds
        run: |
          sudo rm -rf /opt/hostedtoolcache/*/12.* 2>/dev/null || true
          sudo rm -rf /usr/share/dotnet/ 2>/dev/null || true
          sudo rm -rf /usr/local/lib/android/ 2>/dev/null || true
          sudo rm -rf /opt/ghc/ 2>/dev/null || true
          docker system prune -af 2>/dev/null || true
          df -h
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold
      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Install nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest
      - name: Build and test (default)
        if: matrix.feature == 'default'
        run: |
          timeout 300s cargo build -p memory-mcp || exit 1
          timeout 300s cargo nextest run -p memory-mcp --lib || exit 1
      - name: Build and test (wasm-rquickjs)
        if: matrix.feature == 'wasm-rquickjs'
        run: |
          timeout 300s cargo build -p memory-mcp --features wasm-rquickjs || exit 1
          timeout 300s cargo nextest run -p memory-mcp --features wasm-rquickjs --lib || exit 1

  # Multi-platform testing - simplified matrix
  multi-platform:
    name: Multi-Platform Test
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
      - name: Install mold linker (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y mold
      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Install nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest
      - name: Run tests on ${{ matrix.os }}
        run: |
          # Cross-platform timeout wrapper with extended time (900s = 15min)
          # macOS has `gtimeout` from coreutils, or use perl as fallback
          if command -v timeout >/dev/null 2>&1; then
            # Linux with GNU timeout
            timeout 900s cargo nextest run --lib --all
          elif command -v gtimeout >/dev/null 2>&1; then
            # macOS with GNU timeout (coreutils)
            gtimeout 900s cargo nextest run --lib --all
          else
            # macOS fallback: use perl for portable timeout
            # Use -- to separate perl args from command args
            perl -e 'alarm 900; exec @ARGV' -- cargo nextest run --lib --all
          fi

  # Quality gates - final validation
  # NOTE: This job is NOT in the needs: list of other jobs to prevent blocking
  # Coverage is collected separately in coverage.yml workflow
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write      # Required for Codecov OIDC authentication
    timeout-minutes: 45    # Increased from 30 to accommodate slow coverage
    needs: [essential, test, mcp-build, multi-platform]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt, llvm-tools-preview
      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold
      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Install required tools
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov,cargo-audit
      - name: Security Audit
        run: |
          # Security audit with 20 minute timeout
          timeout 1200s cargo audit || echo "Security audit completed with warnings"
        env:
          RUST_LOG: info
      - name: Coverage Check (Library Only)
        run: |
          # Coverage check with 40 minute timeout
          # Use --lib to only test library code (faster than --workspace)
          # Use --jobs to parallelize compilation
          timeout 2400s cargo llvm-cov --lib --lcov --output-path lcov.info --jobs 4
        env:
          RUST_LOG: info
      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./lcov.info
          fail_ci_if_error: false

  # Semver compatibility check - prevents accidental breaking changes
  semver-check:
    name: Semver Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Install cargo-semver-checks
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-semver-checks
      - name: Check semver compatibility
        run: cargo semver-checks check-release --workspace
        continue-on-error: true  # Informational only, not blocking
