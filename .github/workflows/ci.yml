---
name: CI
permissions:
  contents: read
  checks: write
  security-events: write

"on":
  push:
    branches: [main, develop]
  workflow_run:
    workflows: ["Quick Check"]
    types: [completed]
    branches: [main, develop]

# Cancel outdated runs to save resources
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  # Reduce debug symbol size and link-time memory usage in CI (dev profile)
  CARGO_PROFILE_DEV_DEBUG: 0
  CARGO_PROFILE_DEV_CODEGEN_UNITS: 1
  CARGO_INCREMENTAL: 0
  # Limit parallel codegen/linking to reduce peak memory and serialize test builds
  CARGO_BUILD_JOBS: 2
  CARGO_TEST_JOBS: 1
  RUSTFLAGS: "-D warnings"
  JAVY_PLUGIN: "${{ github.workspace }}/memory-mcp/javy-plugin.wasm"

jobs:
  # Only run CI if Quick Check succeeded (for workflow_run) or on direct push
  ci-guard:
    name: CI Guard
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Check if CI should run
        id: check
        run: |
          # shellcheck disable=SC2086
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
            echo "Running CI on push to ${{ github.ref }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
              echo "should-run=true" >> $GITHUB_OUTPUT
              echo "Running CI after successful Quick Check"
            else
              echo "should-run=false" >> $GITHUB_OUTPUT
              echo "Skipping CI due to failed Quick Check"
            fi
          else
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "Unexpected trigger: ${{ github.event_name }}"
          fi

  format:
    name: Format Check
    runs-on: ubuntu-latest
    needs: [ci-guard]
    if: needs.ci-guard.outputs.should-run == 'true'
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    needs: [ci-guard]
    if: needs.ci-guard.outputs.should-run == 'true'
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  unit-tests:
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-unit-${{ matrix.crate }}
      cancel-in-progress: false
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [ci-guard]
    if: needs.ci-guard.outputs.should-run == 'true'
    timeout-minutes: 30
    env:
      CARGO_TARGET_DIR: /tmp/target
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: /tmp/sccache
      SCCACHE_CACHE_SIZE: 2G
    strategy:
      fail-fast: false
      matrix:
        crate: [memory-core, memory-mcp, memory-cli, memory-storage-redb, memory-storage-turso]
    steps:
      - name: Free disk space (aggressive cleanup for Rust builds)
        if: runner.os == 'Linux'
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -f /swapfile || true
          sudo rm -rf /opt/hostedtoolcache/* || true
          sudo rm -rf /usr/share/dotnet/* || true
          sudo rm -rf /usr/local/lib/android/* || true
          sudo rm -rf /opt/ghc/* || true
          sudo apt-get clean || true
          docker system prune -af || true
          echo "After cleanup:"
          df -h
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Install sccache
        uses: taiki-e/install-action@v2
        with:
          tool: sccache
      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: /tmp/sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-
      - name: Run unit tests (libs only)
        run: |
          if [ "${{ matrix.crate }}" = "memory-mcp" ]; then \
            RUSTFLAGS="-C debuginfo=0 -C strip=symbols" \
            cargo test -p memory-mcp --all-features --lib -- --test-threads=1; \
          else \
            cargo test -p ${{ matrix.crate }} --all-features --lib -- --test-threads=4; \
          fi
      - name: Show sccache stats
        if: always()
        run: sccache --show-stats || true

  integration-tests:
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-integration-${{ matrix.crate }}
      cancel-in-progress: false
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [ci-guard]
    if: needs.ci-guard.outputs.should-run == 'true'
    timeout-minutes: 30
    env:
      CARGO_TARGET_DIR: /tmp/target
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: /tmp/sccache
      SCCACHE_CACHE_SIZE: 2G
    strategy:
      fail-fast: false
      matrix:
        crate: [memory-core, memory-mcp, memory-cli, memory-storage-redb, memory-storage-turso]
    steps:
      - name: Free disk space (aggressive cleanup for Rust builds)
        if: runner.os == 'Linux'
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -f /swapfile || true
          sudo rm -rf /opt/hostedtoolcache/* || true
          sudo rm -rf /usr/share/dotnet/* || true
          sudo rm -rf /usr/local/lib/android/* || true
          sudo rm -rf /opt/ghc/* || true
          sudo apt-get clean || true
          docker system prune -af || true
          echo "After cleanup:"
          df -h
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Install sccache
        uses: taiki-e/install-action@v2
        with:
          tool: sccache
      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: /tmp/sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-
      - name: Run integration tests
        run: |
          if [ "${{ matrix.crate }}" = "memory-mcp" ]; then \
            RUSTFLAGS="-C debuginfo=0 -C strip=symbols" \
            cargo test -p memory-mcp --all-features --tests -- --test-threads=1; \
          else \
            cargo test -p ${{ matrix.crate }} --all-features --tests -- --test-threads=2; \
          fi
      - name: Show sccache stats
        if: always()
        run: sccache --show-stats || true

  mcp-feature-matrix:
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-mcp-feature-${{ matrix.feature }}
      cancel-in-progress: false
    name: MCP Feature Matrix
    runs-on: ubuntu-latest
    needs: [ci-guard]
    if: needs.ci-guard.outputs.should-run == 'true'
    timeout-minutes: 45
    env:
      CARGO_TARGET_DIR: /tmp/target
    strategy:
      fail-fast: false
      matrix:
        feature: ["default", "wasm-rquickjs", "javy-backend"]
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Build (default)
        if: matrix.feature == 'default'
        run: |
          RUSTFLAGS="-C debuginfo=0 -C strip=symbols -C panic=abort" \
          cargo build -p memory-mcp && \
          RUSTFLAGS="-C debuginfo=0 -C strip=symbols" \
          cargo test -p memory-mcp -- --test-threads=1
      - name: Build (wasm-rquickjs)
        if: matrix.feature == 'wasm-rquickjs'
        run: |
          RUSTFLAGS="-C debuginfo=0 -C strip=symbols -C panic=abort" \
          cargo build -p memory-mcp --features wasm-rquickjs && \
          RUSTFLAGS="-C debuginfo=0 -C strip=symbols" \
          cargo test -p memory-mcp --features wasm-rquickjs -- --test-threads=1
      - name: Prepare Javy (plugin or CLI)
        if: matrix.feature == 'javy-backend'
        run: |
          echo "Checking for bundled Javy plugin: $JAVY_PLUGIN"
          if [ -f "$JAVY_PLUGIN" ]; then
            echo "Found bundled plugin: $JAVY_PLUGIN"
            exit 0
          fi
          echo "Bundled plugin not found. Checking for javy CLI..."
          if command -v javy >/dev/null 2>&1; then
            echo "javy CLI already installed"
            exit 0
          fi
          echo "Attempting to install javy CLI via cargo (best-effort)"
          cargo install javy || echo "cargo install javy failed; proceeding (tests may skip if javy not available)"
          if command -v javy >/dev/null 2>&1; then
            echo "javy CLI is now available"
          else
            echo "javy CLI not available and plugin missing; Javy tests will be skipped"
          fi
      - name: Build (javy-backend)
        if: matrix.feature == 'javy-backend'
        run: |
          RUSTFLAGS="-C debuginfo=0 -C strip=symbols -C panic=abort" \
          cargo build -p memory-mcp --features javy-backend && \
          RUSTFLAGS="-C debuginfo=0 -C strip=symbols" \
          cargo test -p memory-mcp --features javy-backend -- --test-threads=1

  mcp-matrix:
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-mcp-matrix-${{ matrix.os }}-${{ matrix.rust }}
      cancel-in-progress: false
    name: MCP Matrix
    runs-on: ${{ matrix.os }}
    needs: [ci-guard]
    if: needs.ci-guard.outputs.should-run == 'true'
    timeout-minutes: 45
    env:
      CARGO_TARGET_DIR: /tmp/target
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: /tmp/sccache
      SCCACHE_CACHE_SIZE: 2G
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable]
    steps:
      - name: Free disk space (aggressive cleanup for Rust builds)
        if: runner.os == 'Linux'
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -f /swapfile || true
          sudo rm -rf /opt/hostedtoolcache/* || true
          sudo rm -rf /usr/share/dotnet/* || true
          sudo rm -rf /usr/local/lib/android/* || true
          sudo rm -rf /opt/ghc/* || true
          sudo apt-get clean || true
          docker system prune -af || true
          echo "After cleanup:"
          df -h
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
      - name: Install sccache
        uses: taiki-e/install-action@v2
        with:
          tool: sccache
      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: /tmp/sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Run tests
        run: cargo test --all-features --workspace -- --test-threads=4
        env:
          RUST_LOG: debug
          QUALITY_GATE_SKIP_OPTIONAL: true
      - name: Show sccache stats
        if: always()
        run: sccache --show-stats || true

  build-matrix:
    name: Build (matrix)
    runs-on: ${{ matrix.os }}
    needs: [ci-guard]
    if: needs.ci-guard.outputs.should-run == 'true'
    timeout-minutes: 30
    env:
      CARGO_TARGET_DIR: /tmp/target
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: /tmp/sccache
      SCCACHE_CACHE_SIZE: 2G
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable]
    steps:
      - name: Free disk space (aggressive cleanup for Rust builds)
        if: runner.os == 'Linux'
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -f /swapfile || true
          sudo rm -rf /opt/hostedtoolcache/* || true
          sudo rm -rf /usr/share/dotnet/* || true
          sudo rm -rf /usr/local/lib/android/* || true
          sudo rm -rf /opt/ghc/* || true
          sudo apt-get clean || true
          docker system prune -af || true
          echo "After cleanup:"
          df -h
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
      - name: Install sccache
        uses: taiki-e/install-action@v2
        with:
          tool: sccache
      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: /tmp/sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Run tests
        run: cargo test --all-features --workspace -- --test-threads=4
        env:
          RUST_LOG: debug
          QUALITY_GATE_SKIP_OPTIONAL: true
      - name: Show sccache stats
        if: always()
        run: sccache --show-stats || true

  cli-test:
    name: CLI Test
    runs-on: ubuntu-latest
    needs: [ci-guard]
    if: needs.ci-guard.outputs.should-run == 'true'
    timeout-minutes: 15
    env:
      CARGO_TARGET_DIR: /tmp/target
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: /tmp/sccache
      SCCACHE_CACHE_SIZE: 2G
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
      - name: Install sccache
        uses: taiki-e/install-action@v2
        with:
          tool: sccache
      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: /tmp/sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Build CLI
        run: cargo build --package memory-cli --features full
      - name: Run CLI unit tests
        run: cargo test --package memory-cli --features full --lib
      - name: Run CLI integration tests
        run: cargo test --package memory-cli --features full --test integration_tests
      - name: Run CLI security tests
        run: cargo test --package memory-cli --features full --test security_tests
      - name: Test CLI binary execution
        run: |
          /tmp/target/debug/memory-cli --help
          /tmp/target/debug/memory-cli --version
      - name: Show sccache stats
        if: always()
        run: sccache --show-stats || true

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [ci-guard]
    if: needs.ci-guard.outputs.should-run == 'true'
    timeout-minutes: 20
    env:
      CARGO_TARGET_DIR: /tmp/target
    steps:
      - name: Check disk space
        run: df -h
      - name: Free disk space (Rust build cleanup)
        if: runner.os == 'Linux'
        run: |
          sudo rm -f /swapfile || true
          sudo apt-get clean || true
          docker system prune -af || true
          df -h
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Build workspace (libs + bins only) with timing
        run: cargo build --workspace --all-features --release --bins --lib --timings
      - name: Show sccache stats
        if: always()
        run: sccache --show-stats || true
      - name: Upload build timing report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-timings
          path: /tmp/target/cargo-timings/cargo-timing.html
          retention-days: 7

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: [ci-guard]
    if: needs.ci-guard.outputs.should-run == 'true'
    env:
      CARGO_TARGET_DIR: /tmp/target
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: /tmp/sccache
      SCCACHE_CACHE_SIZE: 2G
    steps:
      - name: Free disk space
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /opt/hostedtoolcache/* || true
          sudo rm -rf /usr/share/dotnet/* || true
          sudo rm -rf /usr/local/lib/android/* || true
          sudo rm -rf /opt/ghc/* || true
          sudo apt-get clean || true
          df -h
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - name: Install sccache
        uses: taiki-e/install-action@v2
        with:
          tool: sccache
      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: /tmp/sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov
      - name: Generate coverage reports and check threshold
        run: |
          cargo llvm-cov clean --workspace
          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info --ignore-run-fail

          # Ensure bc is available for floating point comparison
          if ! command -v bc >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y bc
          fi

          # Extract coverage percentage from LCOV file
          # LH = lines hit, LF = lines found
          LH=$(grep -oP '^LH:\K\d+' lcov.info | awk '{s+=$1} END {print s}')
          LF=$(grep -oP '^LF:\K\d+' lcov.info | awk '{s+=$1} END {print s}')

          if [ -z "$LF" ] || [ "$LF" -eq "0" ]; then
            echo "::error::No coverage data found in lcov.info"
            exit 1
          fi

          COVERAGE=$(awk "BEGIN {printf \"%.2f\", ($LH/$LF)*100}")
          echo "Coverage: ${COVERAGE}% (${LH}/${LF} lines)"

          # Check coverage threshold
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            THRESHOLD=66
          else
            THRESHOLD=70
          fi
          # Use bc for proper floating point comparison
          if [ "$(echo "$COVERAGE < $THRESHOLD" | bc -l)" -eq 1 ]; then
            echo "::error::Coverage ${COVERAGE}% is below ${THRESHOLD}% threshold"
            exit 1
          fi
          echo "Coverage check passed: ${COVERAGE}% >= ${THRESHOLD}% (${GITHUB_EVENT_NAME})"
        env:
          RUST_LOG: debug
      - name: Show sccache stats
        if: always()
        run: sccache --show-stats || true
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: lcov.info
          retention-days: 7

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [ci-guard]
    if: needs.ci-guard.outputs.should-run == 'true'
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      - name: Run cargo audit
        run: cargo audit

  supply-chain:
    name: Supply Chain Security (cargo-deny)
    runs-on: ubuntu-latest
    needs: [ci-guard]
    if: needs.ci-guard.outputs.should-run == 'true'
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Install cargo-deny
        uses: taiki-e/install-action@cargo-deny
      - name: Run cargo-deny
        run: cargo deny check
      - name: Upload deny report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cargo-deny-report
          path: target/deny.log
          retention-days: 7
          if-no-files-found: ignore

  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [ci-guard, format, clippy, unit-tests, integration-tests, cli-test, coverage, security-audit]
    if: needs.ci-guard.outputs.should-run == 'true'
    timeout-minutes: 15
    steps:
      - name: Free disk space
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /opt/hostedtoolcache/* || true
          sudo rm -rf /usr/share/dotnet/* || true
          sudo rm -rf /usr/local/lib/android/* || true
          sudo rm -rf /opt/ghc/* || true
          sudo apt-get clean || true
          df -h
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt, llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Install required tools
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov,cargo-audit
      - name: Run Quality Gates
        run: cargo test --test quality_gates -- --nocapture --skip quality_gate_test_coverage
        env:
          RUST_LOG: info
          QUALITY_GATE_COVERAGE_THRESHOLD: "90"
          QUALITY_GATE_PATTERN_ACCURACY_THRESHOLD: "70"
          QUALITY_GATE_COMPLEXITY_THRESHOLD: "10"
          QUALITY_GATE_SECURITY_THRESHOLD: "0"
      - name: Generate Quality Report
        if: always()
        run: |
          {
            echo "# Quality Gates Report"
            echo ""
            echo "**Date:** $(date)"
            echo ""
            echo "## Configuration"
            echo "- Coverage Threshold: ${QUALITY_GATE_COVERAGE_THRESHOLD}%"
            echo "- Pattern Accuracy Threshold: ${QUALITY_GATE_PATTERN_ACCURACY_THRESHOLD}%"
            echo "- Complexity Threshold: ${QUALITY_GATE_COMPLEXITY_THRESHOLD}"
            echo "- Security Vuln Threshold: ${QUALITY_GATE_SECURITY_THRESHOLD}"
            echo ""
          } > quality-report.md
        env:
          QUALITY_GATE_COVERAGE_THRESHOLD: "90"
          QUALITY_GATE_PATTERN_ACCURACY_THRESHOLD: "70"
          QUALITY_GATE_COMPLEXITY_THRESHOLD: "10"
          QUALITY_GATE_SECURITY_THRESHOLD: "0"
      - name: Upload quality report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-gates-report
          path: quality-report.md
          retention-days: 30
