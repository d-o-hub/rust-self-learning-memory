---
name: CI
permissions:
  contents: read
  checks: write
  security-events: write

"on":
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  # Essential checks - run in parallel for faster feedback
  essential:
    name: Essential Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        job: [format, clippy, doctest]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}

      - name: Format Check
        if: matrix.job == 'format'
        run: cargo fmt --all -- --check

      - name: Clippy
        if: matrix.job == 'clippy'
        run: cargo clippy --all-targets -- -D warnings

      - name: Documentation Tests
        if: matrix.job == 'doctest'
        run: |
          chmod +x scripts/*.sh
          ./scripts/check-doctests.sh

  # Core testing - optimized for speed with proper timeouts
  test:
    name: Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /opt/hostedtoolcache/* || true
          sudo apt-get clean || true
          df -h
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - name: Install nextest
        uses: taiki-e/install-action@nextest
      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Run tests with timeout protection
        run: |
          # Run unit tests first (faster feedback)
          cargo nextest run --profile ci --lib --all --timeout 300
          # Run integration tests if unit tests pass
          cargo nextest run --profile ci --tests --all --timeout 600
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results
          path: target/nextest/ci/junit.xml
          retention-days: 7

  # MCP builds - simplified with timeout protection
  mcp-build:
    name: MCP Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        feature: [default, wasm-rquickjs]
    steps:
      - name: Free disk space for WASM builds
        run: |
          sudo rm -rf /opt/hostedtoolcache/*/12.* 2>/dev/null || true
          sudo rm -rf /usr/share/dotnet/ 2>/dev/null || true
          sudo rm -rf /usr/local/lib/android/ 2>/dev/null || true
          sudo rm -rf /opt/ghc/ 2>/dev/null || true
          docker system prune -af 2>/dev/null || true
          df -h
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Build and test (default)
        if: matrix.feature == 'default'
        run: |
          timeout 300 cargo build -p memory-mcp
          timeout 300 cargo test -p memory-mcp --lib
      - name: Build and test (wasm-rquickjs)
        if: matrix.feature == 'wasm-rquickjs'
        run: |
          timeout 300 cargo build -p memory-mcp --features wasm-rquickjs
          timeout 300 cargo test -p memory-mcp --features wasm-rquickjs --lib

  # Multi-platform testing - simplified matrix
  multi-platform:
    name: Multi-Platform Test
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Run tests on ${{ matrix.os }}
        run: timeout 600 cargo test --lib --all

  # Quality gates - final validation
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [essential, test, mcp-build, multi-platform]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt, llvm-tools-preview
      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - name: Install required tools
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov,cargo-audit
      - name: Run Quality Gates
        run: |
          # Security audit
          cargo audit
          # Coverage check
          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
        env:
          RUST_LOG: info
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./lcov.info
          fail_ci_if_error: false