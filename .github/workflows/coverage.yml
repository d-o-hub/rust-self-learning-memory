---
name: Coverage

permissions:
  contents: read
  checks: write

"on":
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  # Allow manual trigger
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

concurrency:
  group: coverage-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # Comprehensive coverage analysis - runs independently
  # This job does NOT block the main CI workflow
  coverage:
    name: Code Coverage Analysis
    runs-on: ubuntu-latest
    permissions:
      id-token: write      # Required for Codecov OIDC authentication
      contents: read
    timeout-minutes: 60    # Extended timeout for comprehensive coverage
    steps:
      # IMPORTANT: Maximize build space MUST run before checkout
      # This provides 7-8 GB guaranteed space gain via LVM consolidation
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - name: Log disk usage before
        run: |
          echo "=== Disk Usage Before Build ==="
          df -h /
          echo ""
          echo "=== Top 20 Directories by Size ==="
          du -h -d1 / | sort -hr | head -n 20

      - uses: actions/checkout@v4

      - name: Log disk usage after cleanup
        if: always()
        run: |
          echo "=== Disk Usage After Cleanup ==="
          df -h /
          echo ""
          echo "=== Top 20 Directories by Size ==="
          du -h -d1 / | sort -hr | head -n 20

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Generate Coverage Report (Library Only - Fast)
        run: |
          echo "Generating coverage report for library code..."
          # Use --lib for faster coverage of library code only
          # Use --jobs to parallelize
          # Use shell timeout to prevent hanging tests
          timeout 2400s cargo llvm-cov --lib --lcov --output-path lcov.info --jobs 4
          echo "Coverage report generated successfully"
        env:
          RUST_LOG: info
          RUST_BACKTRACE: 1

      - name: Generate Coverage Report (Full Workspace - Optional)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Generating full workspace coverage report..."
          # Only run full workspace coverage on main branch
          # Exclude heavy directories (benches/, examples/) to save disk space
          timeout 3000s cargo llvm-cov --workspace \
            --exclude benches \
            --exclude examples \
            --exclude test-utils \
            --lcov --output-path lcov-full.info --jobs 4 || \
            echo "Full coverage timed out, using library-only report"
          # Use full report if available, otherwise keep library report
          if [ -f lcov-full.info ]; then
            mv lcov-full.info lcov.info
          fi
        env:
          RUST_LOG: info

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./lcov.info
          fail_ci_if_error: false
          name: rust-self-learning-memory
          verbose: true

      - name: Coverage Summary
        run: |
          echo "=== Coverage Analysis Complete ==="
          echo "Coverage report uploaded to Codecov"
          echo "View detailed coverage at: https://codecov.io/gh/${{ github.repository }}"

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ./lcov.info
          retention-days: 7

  # Coverage badge generation
  coverage-badge:
    name: Generate Coverage Badge
    runs-on: ubuntu-latest
    needs: coverage
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: ./coverage
        continue-on-error: true

      - name: Generate badge
        run: |
          echo "=== Coverage Badge Generation ==="

          # Check if coverage report exists
          if [ ! -f ./coverage/lcov.info ]; then
            echo "Warning: Coverage report not found at ./coverage/lcov.info"
            echo "Badge generation skipped"
            exit 0
          fi

          # Extract coverage percentage from lcov.info
          # This is a simplified calculation - sum of hits / sum of total lines
          TOTAL_LINES=$(grep -c '^DA:' ./coverage/lcov.info || echo "0")
          HIT_LINES=$(grep '^DA:' ./coverage/lcov.info | awk -F',' '{if ($2 > 0) print}' | wc -l || echo "0")

          if [ "$TOTAL_LINES" -gt 0 ]; then
            COVERAGE=$(( HIT_LINES * 100 / TOTAL_LINES ))
          else
            COVERAGE=0
          fi

          echo "Calculated coverage: ${COVERAGE}%"
          echo "coverage=${COVERAGE}" >> "$GITHUB_ENV"

          # Determine badge color based on coverage
          if [ "$COVERAGE" -ge 90 ]; then
            COLOR="brightgreen"
          elif [ "$COVERAGE" -ge 80 ]; then
            COLOR="green"
          elif [ "$COVERAGE" -ge 70 ]; then
            COLOR="yellowgreen"
          elif [ "$COVERAGE" -ge 60 ]; then
            COLOR="yellow"
          elif [ "$COVERAGE" -ge 50 ]; then
            COLOR="orange"
          else
            COLOR="red"
          fi

          echo "Badge color: ${COLOR}"
          echo "color=${COLOR}" >> "$GITHUB_ENV"

          echo "=== Badge Generation Complete ==="

      - name: Upload badge artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge
          path: ./coverage/lcov.info
          retention-days: 7
