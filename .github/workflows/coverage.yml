---
name: Coverage

permissions:
  contents: read
  checks: write

"on":
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  # Allow manual trigger
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

concurrency:
  group: coverage-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # Comprehensive coverage analysis - runs independently
  # This job does NOT block the main CI workflow
  coverage:
    name: Code Coverage Analysis
    runs-on: ubuntu-latest
    permissions:
      id-token: write      # Required for Codecov OIDC authentication
      contents: read
    timeout-minutes: 60    # Extended timeout for comprehensive coverage
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /opt/hostedtoolcache/* || true
          sudo apt-get clean || true
          df -h

      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Generate Coverage Report (Library Only - Fast)
        run: |
          echo "Generating coverage report for library code..."
          # Use --lib for faster coverage of library code only
          # Use --jobs to parallelize
          timeout 2400s cargo llvm-cov --lib --lcov --output-path lcov.info --jobs 4
          echo "Coverage report generated successfully"
        env:
          RUST_LOG: info

      - name: Generate Coverage Report (Full Workspace - Optional)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Generating full workspace coverage report..."
          # Only run full workspace coverage on main branch
          # This is slower but provides complete coverage metrics
          timeout 3000s cargo llvm-cov --workspace --lcov --output-path lcov-full.info --jobs 4 || \
            echo "Full coverage timed out, using library-only report"
          # Use full report if available, otherwise keep library report
          if [ -f lcov-full.info ]; then
            mv lcov-full.info lcov.info
          fi
        env:
          RUST_LOG: info

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./lcov.info
          fail_ci_if_error: false
          name: rust-self-learning-memory
          verbose: true

      - name: Coverage Summary
        run: |
          echo "=== Coverage Analysis Complete ==="
          echo "Coverage report uploaded to Codecov"
          echo "View detailed coverage at: https://codecov.io/gh/${{ github.repository }}"

  # Coverage badge generation
  coverage-badge:
    name: Generate Coverage Badge
    runs-on: ubuntu-latest
    needs: coverage
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: ./coverage
        continue-on-error: true

      - name: Generate badge
        run: |
          echo "Coverage badge generation would go here"
          echo "This is a placeholder for future badge automation"
