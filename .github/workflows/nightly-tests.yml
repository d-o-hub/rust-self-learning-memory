---
name: Nightly Full Tests

# Runs all tests including slow integration tests marked with #[ignore]
# Triggered on schedule (nightly) and before releases

"on":
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      run_slow_tests:
        description: 'Run slow integration tests'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  checks: write

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Run all tests including slow ones
  full-test-suite:
    name: Full Test Suite (including slow tests)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      # Tier 1: Maximize build space
      - name: Maximize build space
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 512
          swap-size-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Check disk space before build
        run: |
          df -h
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "Available space: ${AVAILABLE}G"

      - uses: actions/checkout@v4

      # Tier 2: Aggressive cleanup after checkout
      - name: Free disk space (aggressive)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/.ghcup /usr/local/lib/android
          sudo rm -rf /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo rm -rf /opt/hostedtoolcache/PyPy
          docker system prune -af --volumes || true
          sudo apt-get clean
          sudo apt-get autoclean
          df -h

      - name: Check disk space after cleanup
        run: |
          df -h
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "Available space: ${AVAILABLE}G"

      - uses: dtolnay/rust-toolchain@stable

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Check disk space before regular tests
        run: |
          df -h
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "Available space: ${AVAILABLE}G"

      - name: Run regular tests
        run: |
          mkdir -p target/nextest/nightly
          cargo nextest run --profile ci --lib --all --test-threads=4
          cargo nextest run --profile ci --tests --all --test-threads=4 \
            -E 'not binary(compliance)'

      - name: Check disk space before slow tests
        run: |
          df -h
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "Available space: ${AVAILABLE}G"

      - name: Run slow integration tests (ignored tests)
        run: |
          # Run tests marked with #[ignore]
          # These are slow integration tests that timeout in regular CI
          cargo test --all -- --ignored --test-threads=2
        env:
          RUST_TEST_THREADS: 2

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: nightly-test-results
          path: target/nextest/nightly/
          retention-days: 14

  # Run on multiple platforms
  cross-platform-slow-tests:
    name: Slow Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Maximize build space (Linux)
        if: runner.os == 'Linux'
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 512
          swap-size-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Free disk space (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "=== Freeing Disk Space on macOS ==="
          # Remove Xcode simulators to free space
          sudo rm -rf ~/Library/Developer/CoreSimulator/Caches || true
          sudo rm -rf ~/Library/Caches/Homebrew || true
          # Clean up any old logs
          sudo rm -rf /private/var/log/diagnosticPerusal || true
          df -h

      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2.8.2
        with:
          key: ${{ matrix.os }}-slow-tests
          save-if: false  # Don't save cache on slow tests to save space

      - name: Check disk space before slow tests
        run: |
          df -h
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//' || echo "10")
          echo "Available space: ${AVAILABLE}G"

      - name: Run slow integration tests
        run: cargo test --all -- --ignored --test-threads=1
        env:
          RUST_TEST_THREADS: 1

  # Summary job
  nightly-summary:
    name: Nightly Summary
    needs: [full-test-suite, cross-platform-slow-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.full-test-suite.result }}" == "failure" ] || \
             [ "${{ needs.cross-platform-slow-tests.result }}" == "failure" ]; then
            echo "❌ Some nightly tests failed"
            exit 1
          else
            echo "✅ All nightly tests passed"
          fi
