---
name: Nightly Full Tests

# Runs all tests including slow integration tests marked with #[ignore]
# Triggered on schedule (nightly) and before releases

"on":
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      run_slow_tests:
        description: 'Run slow integration tests'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  checks: write

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Run all tests including slow ones
  full-test-suite:
    name: Full Test Suite (including slow tests)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      # Tier 1: Maximize build space
      - name: Maximize build space
        uses: easimon/maximize-build-space@fc881a613ad2a34aca9c9624518214ebc21dfc0c
        with:
          root-reserve-mb: 1024
          swap-size-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Check disk space before build
        run: |
          df -h
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "Available space: ${AVAILABLE}G"

      - uses: actions/checkout@v6

      # Tier 2: Aggressive cleanup after checkout
      - name: Free disk space (aggressive)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/.ghcup /usr/local/lib/android
          sudo rm -rf /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo rm -rf /opt/hostedtoolcache/PyPy
          docker system prune -af --volumes || true
          sudo apt-get clean
          sudo apt-get autoclean
          df -h

      - name: Check disk space after cleanup
        run: |
          df -h
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "Available space: ${AVAILABLE}G"

      - uses: dtolnay/rust-toolchain@stable

      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold

      - name: Install nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Check disk space before regular tests
        run: |
          df -h
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "Available space: ${AVAILABLE}G"
          if [ "$AVAILABLE" -lt 5 ]; then
            echo "❌ ERROR: Insufficient disk space (${AVAILABLE}G < 5G required)"
            df -h
            exit 1
          fi
          echo "✅ Sufficient disk space available: ${AVAILABLE}G"

      - name: Run regular tests
        run: |
          mkdir -p target/nextest/nightly
          cargo nextest run --profile ci --lib --all --test-threads=4
          cargo nextest run --profile ci --tests --all --test-threads=4 \
            -E 'not binary(compliance)'

      - name: Cleanup after regular tests
        run: |
          echo "=== Cleaning up after regular tests ==="
          df -h
          sudo rm -rf target/debug/deps/*.o
          sudo rm -rf target/debug/deps/*.a
          sudo rm -rf target/debug/.fingerprint
          sudo rm -rf target/release/deps/*.o 2>/dev/null || true
          sudo rm -rf target/release/deps/*.a 2>/dev/null || true
          sudo rm -rf ~/.cargo/registry/src/*/cargo-*
          sudo apt-get clean || true
          sudo apt-get autoclean || true
          docker system prune -af --volumes || true
          df -h

      - name: Check disk space before slow tests
        run: |
          df -h
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "Available space: ${AVAILABLE}G"
          if [ "$AVAILABLE" -lt 5 ]; then
            echo "❌ ERROR: Insufficient disk space (${AVAILABLE}G < 5G required)"
            df -h
            exit 1
          fi
          echo "✅ Sufficient disk space available: ${AVAILABLE}G"

      - name: Run slow integration tests (ignored tests)
        run: |
          # Run tests marked with #[ignore]
          # These are slow integration tests that timeout in regular CI
          cargo nextest run --all --run-ignored all
        env:
          RUST_TEST_THREADS: 2

      - name: Cleanup artifacts after slow tests
        if: always()
        run: |
          echo "=== Final cleanup after slow tests ==="
          df -h
          cargo clean || true
          sudo rm -rf target/debug
          sudo rm -rf target/release
          sudo apt-get clean || true
          sudo apt-get autoclean || true
          df -h

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: nightly-test-results
          path: target/debug/nextest/
          if-no-files-found: warn
          retention-days: 14

  # Run slow tests on ubuntu only (macOS not needed for slow test coverage)
  cross-platform-slow-tests:
    name: Slow Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
    steps:
      - name: Maximize build space (Linux)
        if: runner.os == 'Linux'
        uses: easimon/maximize-build-space@fc881a613ad2a34aca9c9624518214ebc21dfc0c
        with:
          root-reserve-mb: 1024
          swap-size-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Free disk space (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "=== Freeing Disk Space on macOS ==="
          # Remove Xcode simulators to free space
          sudo rm -rf ~/Library/Developer/CoreSimulator/Caches || true
          sudo rm -rf ~/Library/Caches/Homebrew || true
          # Clean up any old logs
          sudo rm -rf /private/var/log/diagnosticPerusal || true
          df -h

      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - name: Install mold linker (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y mold

      - uses: Swatinem/rust-cache@v2.8.2
        with:
          key: ${{ matrix.os }}-slow-tests
          save-if: false  # Don't save cache on slow tests to save space

      - name: Install nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Check disk space before slow tests
        run: |
          df -h
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//' || echo "10")
          echo "Available space: ${AVAILABLE}G"
          if [ "$AVAILABLE" -lt 5 ]; then
            echo "❌ ERROR: Insufficient disk space (${AVAILABLE}G < 5G required)"
            df -h
            exit 1
          fi
          echo "✅ Sufficient disk space available: ${AVAILABLE}G"

      - name: Run slow integration tests
        run: cargo nextest run --all --run-ignored all
        env:
          RUST_TEST_THREADS: 1

  # Mutation testing - validates test suite effectiveness
  mutation-testing:
    name: Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Mutation testing is slow
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable

      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold

      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}

      - name: Install cargo-mutants
        run: cargo install --locked cargo-mutants

      - name: Run mutation testing on memory-core
        run: |
          cargo mutants --package memory-core --timeout 300 --jobs 4 -- --lib
        continue-on-error: true  # Informational - don't block on mutation results

      - name: Upload mutation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-report
          path: mutants.out/
          retention-days: 7

  # Summary job
  nightly-summary:
    name: Nightly Summary
    needs: [full-test-suite, cross-platform-slow-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.full-test-suite.result }}" == "failure" ] || \
             [ "${{ needs.cross-platform-slow-tests.result }}" == "failure" ]; then
            echo "❌ Some nightly tests failed"
            exit 1
          else
            echo "✅ All nightly tests passed"
          fi
