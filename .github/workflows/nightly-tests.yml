---
name: Nightly Full Tests

# Runs all tests including slow integration tests marked with #[ignore]
# Triggered on schedule (nightly) and before releases

"on":
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      run_slow_tests:
        description: 'Run slow integration tests'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  checks: write

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Run all tests including slow ones
  full-test-suite:
    name: Full Test Suite (including slow tests)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /opt/hostedtoolcache/* || true
          sudo apt-get clean || true
          df -h

      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - uses: Swatinem/rust-cache@v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Run regular tests
        run: |
          mkdir -p target/nextest/nightly
          cargo nextest run --profile ci --lib --all --test-threads=4
          cargo nextest run --profile ci --tests --all --test-threads=4 \
            -E 'not binary(compliance)'

      - name: Run slow integration tests (ignored tests)
        run: |
          # Run tests marked with #[ignore]
          # These are slow integration tests that timeout in regular CI
          cargo test --all -- --ignored --test-threads=2
        env:
          RUST_TEST_THREADS: 2

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-test-results
          path: target/nextest/nightly/
          retention-days: 14

  # Run on multiple platforms
  cross-platform-slow-tests:
    name: Slow Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2.8.2
        with:
          key: ${{ matrix.os }}-slow-tests

      - name: Run slow integration tests
        run: cargo test --all -- --ignored --test-threads=1
        env:
          RUST_TEST_THREADS: 1

  # Summary job
  nightly-summary:
    name: Nightly Summary
    needs: [full-test-suite, cross-platform-slow-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.full-test-suite.result }}" == "failure" ] || \
             [ "${{ needs.cross-platform-slow-tests.result }}" == "failure" ]; then
            echo "❌ Some nightly tests failed"
            exit 1
          else
            echo "✅ All nightly tests passed"
          fi
