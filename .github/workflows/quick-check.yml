---
name: Quick Check

"on":
  pull_request:
    branches: [main, develop]

# Cancel outdated runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

permissions:
  contents: read

jobs:
  quick-check:
    name: Quick PR Check (Format + Clippy)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - name: Setup isolated target dir
        run: |
          chmod +x scripts/setup-target-dir.sh
          ./scripts/setup-target-dir.sh quick-check

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold

      - uses: Swatinem/rust-cache@v2.8.2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy on lib
        run: |
          cargo clippy --lib -- \
            -D warnings \
            -A clippy::expect_used \
            -A clippy::uninlined_format_args \
            -A clippy::unwrap_used

      - name: Run clippy on tests
        run: |
          cargo clippy --tests -- \
            -D warnings \
            -A clippy::expect_used \
            -A clippy::uninlined_format_args \
            -A clippy::unwrap_used

      - name: Run documentation tests
        run: |
          chmod +x scripts/*.sh
          ./scripts/check-doctests.sh
