# v0.1.3 Implementation Plan: Optional CLI Interface

> **Version**: 0.1.3
> **Release Date**: Target 2025-12-29
> **Status**: Planning Phase
> **Priority**: Medium

## Executive Summary

This plan outlines the implementation of an optional CLI interface (`memory-cli`) alongside the existing MCP server for version 0.1.3. The CLI provides direct command-line access to memory operations for debugging, administration, and automation purposes, complementing the MCP server without introducing breaking changes.

**Key Objectives**:
- Add optional `memory-cli` crate with comprehensive episode/pattern management
- Maintain backward compatibility with existing MCP server
- Provide debugging and operational tooling for production deployments
- Enable scriptable automation for common memory operations

---

## Implementation Overview

### Architecture

The CLI will be implemented as a new optional crate (`memory-cli`) that depends on `memory-core` and the storage backends. It will provide a command-line interface to the same functionality exposed by the MCP server, ensuring consistency and shared validation logic.

```
memory-cli (NEW)
├── memory-core (existing)
├── memory-storage-turso (existing)
├── memory-storage-redb (existing)
└── clap (CLI framework)
```

### Feature Flag Integration

The CLI will be gated behind an optional feature flag to maintain the existing lightweight deployment options:

```toml
# In memory-cli/Cargo.toml
[features]
default = []
turso = ["memory-storage-turso"]
redb = ["memory-storage-redb"]
full = ["turso", "redb"]
```

### Command Structure

```bash
memory-cli [OPTIONS] <COMMAND>

Commands:
  episode     Episode management (create, list, view, search)
  pattern     Pattern analysis and management
  storage     Storage operations and diagnostics
  completion  Generate shell completion scripts

Options:
  --config <FILE>     Configuration file path
  --format <FORMAT>   Output format (human, json, yaml)
  --verbose           Enable verbose output
  --dry-run           Show what would be done without executing
```

---

## Phase 1: Foundation & Core Commands (Week 1-2)

### 1.1 Project Setup & Configuration

**Effort**: 4 hours
**Dependencies**: None

**Tasks**:
- [ ] Create `memory-cli/` directory structure
- [ ] Add `memory-cli` to workspace members
- [ ] Set up `clap` for CLI parsing with subcommands
- [ ] Implement basic configuration loading (TOML/JSON)
- [ ] Add CLI feature flag to workspace Cargo.toml

**Deliverables**:
- Basic CLI skeleton with help system
- Configuration file parsing
- Workspace integration

### 1.2 Episode Management Commands

**Effort**: 8 hours
**Dependencies**: Phase 1.1

**Commands to Implement**:
```bash
# Episode CRUD operations
memory-cli episode create --task "task description" --context "context.json"
memory-cli episode list [--task-type <type>] [--limit <n>] [--status <status>]
memory-cli episode view <episode-id>
memory-cli episode complete <episode-id> --outcome success|partial|failure
memory-cli episode search "query text" [--limit <n>]

# Episode steps
memory-cli episode log-step <episode-id> --tool "tool_name" --action "action" --success true|false
```

**Features**:
- [ ] JSON/YAML output formats for scripting
- [ ] Human-readable table output for interactive use
- [ ] Episode status filtering and pagination
- [ ] Step logging with validation

**Deliverables**:
- Complete episode lifecycle management via CLI
- 8 core episode commands implemented
- Input validation and error handling

### 1.3 Storage Operations

**Effort**: 6 hours
**Dependencies**: Phase 1.1

**Commands to Implement**:
```bash
# Storage diagnostics
memory-cli storage stats
memory-cli storage sync [--force] [--dry-run]
memory-cli storage vacuum [--dry-run]

# Health checks
memory-cli storage health
memory-cli storage connections
```

**Features**:
- [ ] Real-time storage statistics (episode count, pattern count, storage size)
- [ ] Manual sync operations with progress reporting
- [ ] Health status reporting for both Turso and redb
- [ ] Connection pool status and diagnostics

**Deliverables**:
- Storage inspection and maintenance commands
- Health monitoring capabilities
- Manual sync controls

---

## Phase 2: Pattern Analysis & Advanced Features (Week 3-4)

### 2.1 Pattern Management Commands

**Effort**: 8 hours
**Dependencies**: Phase 1.2

**Commands to Implement**:
```bash
# Pattern inspection
memory-cli pattern list [--min-confidence <f>] [--type <type>] [--limit <n>]
memory-cli pattern view <pattern-id>
memory-cli pattern analyze <pattern-id> [--episodes <n>]

# Pattern effectiveness
memory-cli pattern effectiveness [--top <n>] [--min-uses <n>]
memory-cli pattern decay [--dry-run] [--force]
```

**Features**:
- [ ] Pattern confidence scoring display
- [ ] Effectiveness metrics (usage count, success rate, recency)
- [ ] Pattern decay simulation and execution
- [ ] Type-based filtering and sorting

**Deliverables**:
- Complete pattern inspection toolkit
- Effectiveness analysis and reporting
- Pattern maintenance operations

### 2.2 Advanced CLI Features

**Effort**: 6 hours
**Dependencies**: Phase 2.1

**Features to Implement**:
- [ ] Shell completion generation (bash, zsh, fish)
- [ ] Interactive mode for complex operations
- [ ] Batch processing for bulk operations
- [ ] Progress bars for long-running operations
- [ ] Colored output and formatting

**Commands to Add**:
```bash
# Meta commands
memory-cli completion <shell>
memory-cli version
memory-cli config validate
```

**Deliverables**:
- Production-ready CLI experience
- Shell integration support
- Configuration validation

### 2.3 Testing & Benchmarking

**Effort**: 20 hours
**Dependencies**: Phase 2.2

#### Unit Tests

**Tasks**:
- [ ] Command parsing validation tests
- [ ] Configuration loading and validation tests
- [ ] Output formatting tests (human, JSON, YAML)
- [ ] Error handling and edge case tests
- [ ] Input validation tests

**Coverage Targets**:
- Command argument parsing: >95%
- Configuration handling: >95%
- Output formatting: >95%
- Error scenarios: >90%

#### Integration Tests

**Tasks**:
- [ ] End-to-end CLI workflows with test database
- [ ] Command combination and pipeline testing
- [ ] Cross-platform compatibility testing
- [ ] Memory and resource usage validation
- [ ] Concurrent operation testing

**Test Scenarios**:
- Episode lifecycle: create → log steps → complete → retrieve
- Pattern analysis workflow: list → analyze → effectiveness
- Storage operations: sync → health check → vacuum
- Error recovery: network failures, invalid inputs, permission issues

#### Performance Benchmarks

**Tasks**:
- [ ] CLI startup time benchmarking
- [ ] Command execution latency measurement
- [ ] Memory usage profiling
- [ ] Large dataset handling performance
- [ ] Concurrent user simulation

**Benchmark Targets**:
| Operation | Target (P95) | Success Criteria |
|-----------|-------------|------------------|
| CLI startup | <500ms | Cold start time |
| Episode list (100 items) | <200ms | Query performance |
| Episode view | <100ms | Single item retrieval |
| Pattern analysis | <500ms | Complex computation |
| Storage sync | <2s | Background operation |
| JSON output formatting | <50ms | Serialization overhead |
| Memory usage | <50MB peak | Resource efficiency |

**Benchmark Environment**:
- Test database with 1000 episodes, 100 patterns
- 10 concurrent CLI processes
- 1GB memory limit per process
- Network latency simulation (0-100ms)

#### Security Tests

**Tasks**:
- [ ] Input sanitization validation
- [ ] Path traversal prevention tests
- [ ] SQL injection prevention (parameterized queries)
- [ ] Credential exposure prevention
- [ ] File permission boundary testing

**Security Requirements**:
- No credential logging in verbose mode
- Safe path handling (no `../` traversal)
- Input size limits (prevent DoS)
- Secure temporary file handling

#### Compatibility Tests

**Tasks**:
- [ ] Feature flag functionality testing
- [ ] Build without CLI validation
- [ ] MCP server coexistence testing
- [ ] Version compatibility testing
- [ ] Dependency version matrix testing

**Deliverables**:
- Comprehensive test suite (200+ tests)
- Performance benchmark suite with baselines
- Security test validation report
- Compatibility matrix documentation
- Test coverage report (>90%)

---

## Phase 3: Documentation & Production Readiness (Week 5)

### 3.1 Documentation

**Effort**: 6 hours
**Dependencies**: Phase 2.3

**Tasks**:
- [ ] CLI user guide and command reference
- [ ] Configuration examples and templates
- [ ] Troubleshooting guide for common issues
- [ ] Update README.md with CLI usage examples

**Deliverables**:
- Complete CLI documentation
- Usage examples and tutorials
- Troubleshooting guides

### 3.2 Quality Assurance

**Effort**: 4 hours
**Dependencies**: Phase 3.1

**Tasks**:
- [ ] Code review and clippy compliance
- [ ] Security audit for CLI-specific concerns
- [ ] Performance optimization
- [ ] Final integration testing

**Deliverables**:
- Production-ready code quality
- Security validation
- Performance optimization

---

## Dependencies & Prerequisites

### External Dependencies

| Dependency | Version | Purpose | License |
|------------|---------|---------|---------|
| `clap` | 4.4 | CLI argument parsing | MIT/Apache-2.0 |
| `serde_yaml` | 0.9 | YAML output support | MIT/Apache-2.0 |
| `colored` | 2.0 | Colored terminal output | MIT |
| `indicatif` | 0.17 | Progress bars | MIT |

### Internal Dependencies

- `memory-core`: Core memory operations
- `memory-storage-turso`: Turso backend (optional)
- `memory-storage-redb`: redb backend (optional)

### Build Requirements

- Rust 1.70+ (workspace requirement)
- Cargo with workspace support
- Optional: Turso/redb for full functionality

---

## Success Criteria

### Functional Requirements

- [ ] **Episode Management**: Full CRUD operations via CLI
- [ ] **Pattern Analysis**: Comprehensive pattern inspection and analysis
- [ ] **Storage Operations**: Health checks, sync, and maintenance
- [ ] **Output Formats**: Human-readable, JSON, YAML support
- [ ] **Error Handling**: Clear error messages and exit codes
- [ ] **Shell Integration**: Completion scripts for bash/zsh/fish

### Quality Requirements

- [ ] **Code Quality**: Zero clippy warnings, follows project standards
- [ ] **Test Coverage**: >90% for CLI crate (200+ tests)
- [ ] **Documentation**: Complete command reference and examples
- [ ] **Performance**: All benchmark targets met (see Phase 2.3 benchmarks)
- [ ] **Security**: No credential exposure, secure configuration handling, security tests pass

### Testing Requirements

- [ ] **Unit Tests**: >95% coverage for core functionality
- [ ] **Integration Tests**: End-to-end workflows validated
- [ ] **Performance Tests**: All operations meet P95 targets
- [ ] **Security Tests**: Input sanitization, path traversal prevention, SQL injection protection
- [ ] **Compatibility Tests**: Feature flags, MCP coexistence, cross-platform support

### Benchmark Requirements

- [ ] **Startup Performance**: <500ms cold start time
- [ ] **Query Performance**: Episode list (100 items) <200ms
- [ ] **Retrieval Performance**: Episode view <100ms
- [ ] **Analysis Performance**: Pattern analysis <500ms
- [ ] **Memory Usage**: <50MB peak memory usage
- [ ] **Concurrent Operations**: 10 concurrent CLI processes supported

---

## Testing Strategy

### Integration with Existing Test Infrastructure

The CLI testing will integrate with the existing test framework:

#### Test Organization
```
memory-cli/tests/
├── unit/           # Unit tests for individual components
├── integration/    # End-to-end CLI workflow tests
├── performance/    # Benchmark tests
├── security/       # Security validation tests
└── compatibility/  # Feature flag and platform tests
```

#### Test Database Setup
- **Ephemeral Databases**: Use temporary Turso instances and redb files for testing
- **Test Data Generation**: Automated generation of realistic episode/pattern data
- **Cleanup**: Automatic cleanup after test completion
- **Isolation**: Each test gets its own database instance

#### CI/CD Integration
- **Quality Gates**: CLI tests included in existing quality gates
- **Performance Regression**: Benchmarks run on every PR
- **Coverage Reporting**: CLI coverage included in overall project coverage
- **Security Scanning**: CLI-specific security tests in CI pipeline

### Test Data Strategy

#### Realistic Test Datasets
- **Small Dataset**: 10 episodes, 5 patterns (unit tests)
- **Medium Dataset**: 100 episodes, 20 patterns (integration tests)
- **Large Dataset**: 1000 episodes, 100 patterns (performance tests)

#### Data Generation
- **Automated Scripts**: Generate consistent test data
- **Edge Cases**: Include malformed data, large payloads, special characters
- **Performance Scenarios**: Generate data that exercises different code paths

### Benchmarking Framework

#### Tools and Libraries
- **Criterion**: For micro-benchmarks of CLI operations
- **Custom Harness**: For end-to-end workflow benchmarking
- **Memory Profiling**: Track memory usage during operations
- **Concurrent Testing**: Simulate multiple CLI users

#### Benchmark Categories
- **Cold Start**: Initial CLI startup time
- **Hot Operations**: Subsequent command execution
- **Memory Efficiency**: Peak and average memory usage
- **I/O Performance**: Database query and file I/O operations
- **Concurrent Load**: Multiple CLI processes running simultaneously

#### Baseline Establishment
- **Initial Baselines**: Establish performance baselines during development
- **Regression Detection**: Automatic failure on performance degradation
- **Environment Consistency**: Control test environment variables
- **Statistical Analysis**: Use statistical methods to account for variance

---

## Risk Assessment & Mitigation

### High-Risk Items

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| **Configuration complexity** | Medium | Medium | Shared config system with MCP, comprehensive validation |
| **Performance overhead** | Low | Low | Optional crate, minimal impact on existing builds |
| **Security vulnerabilities** | High | Low | Security audit, no credential handling in CLI |
| **API inconsistency** | Medium | Low | Use same core logic as MCP server |

### Contingency Plans

- **Scope Reduction**: If timeline pressure, implement core episode commands first
- **Feature Gating**: CLI features can be incrementally added post-v0.1.3
- **Rollback Plan**: CLI crate can be removed without affecting core functionality

---

## Timeline & Milestones

### Week 1: Foundation (Nov 18-24)
- [ ] Project setup and basic CLI structure
- [ ] Configuration system implementation
- [ ] Basic episode list/view commands

### Week 2: Core Functionality (Nov 25-Dec 1)
- [ ] Complete episode management commands
- [ ] Storage operations implementation
- [ ] Basic pattern commands

### Week 3: Advanced Features (Dec 2-8)
- [ ] Pattern analysis and effectiveness tracking
- [ ] Shell completion and interactive features
- [ ] Batch processing capabilities

### Week 4: Testing & Benchmarking (Dec 9-22)
- [ ] Unit test implementation (command parsing, config, output)
- [ ] Integration test development (end-to-end workflows)
- [ ] Performance benchmarking (startup, queries, memory usage)
- [ ] Security testing (input validation, path traversal)
- [ ] Compatibility testing (feature flags, platforms)

### Week 5: Documentation & Finalization (Dec 23-29)
- [ ] CLI user guide and command reference
- [ ] Configuration examples and troubleshooting
- [ ] Performance optimization based on benchmarks
- [ ] Security review and final validation
- [ ] Release preparation and documentation review

**Target Release Date**: December 29, 2025

---

## Integration Points

### With Existing MCP Server

- **Shared Logic**: CLI uses same core functions as MCP for consistency
- **Configuration**: Common configuration file format
- **Validation**: Identical input validation rules
- **Error Handling**: Consistent error reporting

### With Storage Backends

- **Connection Management**: Uses existing connection pools
- **Transaction Handling**: Leverages existing sync mechanisms
- **Health Monitoring**: Integrates with existing health checks

### With Build System

- **Feature Flags**: Optional compilation via feature flags
- **Workspace Integration**: Standard Cargo workspace member
- **CI/CD**: Integrated into existing build pipeline

---

## Testing Strategy

### Unit Tests
- Command parsing validation
- Configuration loading tests
- Output formatting tests

### Integration Tests
- End-to-end CLI workflows
- Database interaction testing
- Error condition handling

### Performance Tests
- CLI startup time benchmarking
- Command execution performance
- Memory usage validation

### Compatibility Tests
- Feature flag functionality
- Build without CLI
- MCP server coexistence

---

## Deployment & Distribution

### Packaging

The CLI will be distributed as:
- Optional crate feature (`--features cli`)
- Standalone binary (`memory-cli`)
- Docker image with CLI included

### Installation

```bash
# Install with CLI
cargo install --features cli memory-cli

# Or build from source
cargo build --release --features cli
```

### Documentation Distribution

- CLI reference in project README
- Separate CLI user guide
- Man pages generation (future)

---

## Success Metrics

### Adoption Metrics
- CLI commands used in operational runbooks
- Reduction in manual database queries
- Integration into deployment scripts

### Quality Metrics
- Zero production issues in first month
- <100ms response time for all commands
- >95% test coverage maintained

### User Experience Metrics
- Intuitive command structure
- Clear error messages
- Effective help system

---

## Future Enhancements (Post-v0.1.3)

### v0.1.4+ Possibilities
- Interactive episode builder
- Pattern visualization
- Advanced search with embeddings
- Plugin system for custom commands

### Integration Opportunities
- CI/CD pipeline integration
- Monitoring dashboard data source
- Automated backup validation

---

## References

### Testing & Benchmarking Documentation

- **[TESTING.md](../TESTING.md)** - Project testing guidelines and quality gates
- **[PERFORMANCE_BASELINES.md](../plans/PERFORMANCE_BASELINES.md)** - Performance benchmarking standards
- **[AGENTS.md](../AGENTS.md)** - Agent responsibilities and operational guidance
- **[SECURITY.md](../SECURITY.md)** - Security testing requirements

### Related Implementation Plans

- **[plans/04-review.md](../plans/04-review.md)** - Quality assessment and compliance testing
- **[plans/05-secure.md](../plans/05-secure.md)** - Security analysis and penetration testing
- **[plans/06-feedback-loop.md](../plans/06-feedback-loop.md)** - Performance monitoring and optimization

### External Resources

- **[Criterion.rs](https://bheisler.github.io/criterion.rs/)** - Rust benchmarking framework
- **[clap](https://docs.rs/clap/)** - Command-line argument parsing
- **[Testing in Rust](https://doc.rust-lang.org/book/ch11-00-testing.html)** - Official Rust testing guide

---

**Document Version**: 1.1
**Last Updated**: 2025-11-17
**Author**: GOAP Agent
**Review Status**: Ready for implementation